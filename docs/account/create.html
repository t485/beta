<!DOCTYPE html>

<html lang="en">

<head>
	
		<meta charset="utf-8">
		<meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport">
		<meta content=" The official Boy Scout Troop 485 website. " name="description">
	
	 
	
		<title>Troop 485</title>
		
	

	
		<!-- Bootstrap core CSS -->
		<link href="/css/bootstrap.min.css" rel="stylesheet">
		<!-- Custom fonts for this template -->
		<link href="https://fonts.googleapis.com/css?family=Raleway:100,100i,200,200i,300,300i,400,400i,500,500i,600,600i,700,700i,800,800i,900,900i"
			rel="stylesheet">
		<link href="https://fonts.googleapis.com/css?family=Lora:400,400i,700,700i" rel="stylesheet">
		<!-- Custom styles for this template -->
		<link href="/css/theme.css" rel="stylesheet">
		<link href="/css/t485.css" rel="stylesheet">
	
	
		<!-- Favicons -->
		<link rel="apple-touch-icon" sizes="152x152" href="/favicons/apple-touch-icon-152x152.png">
		<link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon-180x180.png">
		<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
	
	
	
	
		<script>
			try {
				localStorage.setItem('firebaseErrorTest', 'test');
			}
			catch (e) {
				console.log(e)
				if (e.message === 'The quota has been exceeded.') {
					// using Safari(desktop & iOS) or Chrome(iOS) w/ private, localStorage not supported
					// firebase will throw error, so better to alert user now
					alert("Private browsing is not supported on Safari or the Chrome IOS app. " +
					"Turn off private browsing or use a supported private browsing app.");
				}
				throw 'notEnoughLocalStorage';
			}
		</script>
	
</head>

<body>
	
		<div class="text-center">
			<a href="/">
				<img src="/img/header.png" alt="Boy Scout Troop 485" id="header">
			</a>
		</div>
	
	
	

		<div id="alertBox">
		</div>
	
	
		<!-- Navigation -->


		<nav class="navbar navbar-expand-lg navbar-light py-lg-4" id="navbar">
			<div class="container">
				<a class="navbar-brand text-uppercase text-expanded font-weight-bold d-lg-none" href="/">Troop 485</a>
				<button aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation"
						class="navbar-toggler"
					data-target="#navbarResponsive" data-toggle="collapse" type="button">
					<span class="navbar-toggler-icon"></span>
				</button>

				<div class="collapse navbar-collapse" id="navbarResponsive">
					<ul class="navbar-nav mx-auto">


						<li class="nav-item px-lg-4">
							<a class="nav-link text-uppercase text-expanded" href="/">Home</a>
						</li>

						<li class="nav-item px-lg-4">
							<a class="nav-link text-uppercase text-expanded" href="/calendar.html">Calendar</a>
						</li>
						<li class="nav-item px-lg-4">
							<a class="nav-link text-uppercase text-expanded" href="/directory.html">Directory</a>
						</li>
						<li class="nav-item px-lg-4">
							<a class="nav-link text-uppercase text-expanded" href="/event-pages.html">Event Pages</a>
						</li>
						<li class="nav-item px-lg-4">
							<a class="nav-link text-uppercase text-expanded" href="/pictures.html">Pictures</a>
						</li>




						<li class="nav-item dropdown px-lg-4">
							<a class="nav-link dropdown-toggle text-uppercase text-expanded"
							   data-toggle="dropdown" href="#" role="button">About</a>

							<div class="dropdown-menu">
								<a class="dropdown-item" href="/about/faq.html">FAQ</a>
								<a class="dropdown-item" href="/about/merit-badges.html">Merit Badges</a>
							</div>
						</li>
						<li class="nav-item dropdown px-lg-4">
							<a aria-expanded="false" aria-haspopup="true"
							   class="nav-link dropdown-toggle text-uppercase text-expanded" data-toggle="dropdown"
							   href="#" id="account-dropdown" role="button">Account</a>

							<div aria-labelledby="account-dropdown" class="dropdown-menu">
								<h6 class="dropdown-header">You are not logged in.</h6>
								<a class="dropdown-item" href="/account/login.html">Login</a>
							</div>
						</li>
					</ul>
				</div>
			</div>
		</nav>
	
	

		<div class="container" id="mainContainer">
			
<div class="row col-lg-12" id="loading">
    <div class="box w-100">
        <div class="col-lg-12" id="loading-inner">
            <h2 class="primary-heading">Loading...</h2>
            <p class="text-muted">Loading...</p>


        </div>
    </div>
</div>
<div class="row col-lg-12 hidden" id="nokey-box">
    <div class="box w-100">
        <div class="col-lg-12" id="nokey">
            <h2 class="primary-heading">Create Account</h2>
			<p class="text-muted">Please contact the webmaster(<a class="webmaster-email">Jeffrey Meng</a>) to get a create link to create your account.</p>


        </div>
    </div>
</div>
<div class="row col-lg-12 hidden" id="main-box">
    <div class="box w-100">
        <div class="col-lg-12 hidden" id="basic-data">
            <h2 class="primary-heading">Create Account</h2>

            <div class="form-group">
                <label for="email">Email address:</label>
                <input type="email" class="form-control" id="email" placeholder="Enter your email...">
                <div class="invalid-feedback" id="em-validation-invalid">
                    Please enter a valid email.
                </div>
                <div class="invalid-feedback hidden" id="em-validation-inuse">
                    The email provided is already used in an account. <a href="/account/login" class="text-danger">Login</a> instead?
                </div>
            </div>
            <div class="form-group">
                <label for="password">Password:</label>
                <input type="password" class="form-control" id="password" placeholder="Enter your password...">
                <div class="invalid-feedback pw-validation" id="pw-validation-none">
                    Please enter a password.
                </div>
                <div class="invalid-feedback pw-validation hidden" id="pw-validation-strength">
                    Please enter a stronger password. Try adding numbers, uppercase and lowercase letters, and special characters.
                </div>
            </div>
            <div class="form-group">
                <label for="password">Confirm Password:</label>
                <input type="password" class="form-control" id="confirm-password" placeholder="Confirm password...">
                <div class="invalid-feedback pw-validation">
                    Enter a matching password!
                </div>
            </div>
            <button class="btn btn-primary btn-block" id="next-btn">Next</button>
            <p class="text-danger" id="error"></p>
			<p id="account-tray" class="text-center"><a href="/account/login.html" id="login-link">Login</a> | <a href="/account/resetpassword.html" id="forgot-password-link">Forgot password</a></p>
        </div>
        <div class="col-lg-12 hidden" id="check-email">
            <h2 class="primary-heading">Check your email!</h2>
            <p>We sent a verification email to <b class="orig-email">loading...</b> on <b class="sent-date">loading...</b>. Follow the link on that email to finish setting up your account.</p>
            <p><a href="#" class="text-center resend" id="resend">Resend the verification email</a>
                <span id="resend-countdown" class="resend hidden">You can resend the verification email in <b class="resend-time-remaining">Synchronizing...</b> second<span class="resend-plural">s</span>.</span>
                <span id="resend-success" class="resend hidden">Email successfully resent. You can resend the verification email again in <b class="resend-time-remaining">60</b> second<span class="resend-plural">s</span>.</span>
                <span id="error-resending" class="resend hidden">Error resending. <a href="/account/create.html">Please reload</a> to try again.</span>
                <span id="resend-loading" class="resend hidden">Resending email...</span>
            </p>
        </div>
        <div class="col-lg-12 hidden" id="unknown-error">
            <h2 class="primary-heading">An Error Occurred</h2>
            <p>If this was unexpected, please contact the webmaster. Code: <span id="unknown-error-text">unknown-error</span></p>

        </div>
    </div>
</div>



		</div>
	
	
	<div class="container hidden" id="unexpectederror">

		<div class="row">
			<div class="box">
				<div class="col-lg-12">
					<h2 class="error">An Unexpected Error Occured</h2>


					<p>Please report this bug or try again in a few minutes. <b>Code <span id="unexpectederror-code">UNKNOWN_ERR</span></b></p>

				</div>
			</div>
		</div>
	</div>
	
	

		<footer class="footer text-faded text-center py-5">
			<div class="container">
				<p class="m-0 small">Copyright &copy; 2006-2018 Troop 485, Silicon Valley Monterey Bay Council,
					Boy Scouts of America.</p>
			</div>
		</footer>
	

	
		<script src="https://www.gstatic.com/firebasejs/5.5.3/firebase-app.js">
		</script>
		<script src="https://www.gstatic.com/firebasejs/5.5.3/firebase-auth.js">
		</script>
		<script src="https://www.gstatic.com/firebasejs/5.5.3/firebase-database.js">
		</script>
		<script src="https://www.gstatic.com/firebasejs/5.5.3/firebase-storage.js">
		</script>
		<!-- <script src="https://www.gstatic.com/firebasejs/5.5.3/firebase-firestore.js"></script> -->
		<!-- <script src="https://www.gstatic.com/firebasejs/5.5.3/firebase-messaging.js"></script> -->
		<!-- <script src="https://www.gstatic.com/firebasejs/5.5.3/firebase-functions.js"></script> -->

		<script>
			// Initialize Firebase
			var config = {
				apiKey: "AIzaSyB-ly8ax35aWTAGhX2UDVuYxPSDlAU8kMk",
				authDomain: "t485-main.firebaseapp.com",
				databaseURL: "https://t485-main.firebaseio.com",
				projectId: "t485-main",
				storageBucket: "t485-main.appspot.com",
				messagingSenderId: "368513727602"
			};
			firebase.initializeApp(config);
		</script>
	
	
		<!-- Bootstrap core JavaScript -->

		<script src="/js/jquery.min.js">
		</script>
		<script src="/js/popper.min.js">
		</script>
		<script src="/js/bootstrap.min.js">
		</script>
		<script src="/js/t485.js">
		</script>
	
	
<script id="scripts">

	if (getQuery("continue") != "" && getQuery("continue") != null) {
		$("#login-link").attr("href", "/account/create.html?continue=" + getQuery("continue"));
		$("#forgot-password-link").attr("href", "/account/resetpassword.html?continue=" + getQuery("continue"));
	}
    firebase.auth().onAuthStateChanged(function (user) {
        if (user) {

            console.log(user);


            firebase.database().ref("/users/" + user.uid + "/latestverificationemail/").once("value").then(function(snapshot) {
                var data = snapshot.val();
                console.log(data);
                if (data == null) {
                    sendverificationemail(user, function(dateobj) {

                        if (dateobj === false || dateobj == null) {

                            //error
							console.log(dateobj);
							$("#loading").addClass("hidden");
							$("#main-box").removeClass("hidden");
							$("#unknown-error-text").text("VERIF_EMAIL_FAILED");
							$("#basic-data").addClass("hidden");
							$("#check-email").addClass("hidden");
							$("#unknown-error").removeClass("hidden");
                        } else {

                            $(".sent-date").text(getHumanDate(dateobj));
                            $(".orig-email").text(user.providerData[0].email);
							startResendTimer(true);

						}

                    });
                } else {

                    if (new Date() - new Date(data.date) < 60 * 1000) {//60 seconds ago
						console.log(new Date() - new Date(data.date));
						startResendTimer(true, 60 - (Math.round((new Date() - new Date(data.date)) / 1000)));

					}
                    console.log(data);
                    $(".sent-date").text(getHumanDate(data));
                    $(".orig-email").text(user.providerData[0].email);
                }
                $("#loading").addClass("hidden");
                $("#main-box").removeClass("hidden");
                $("#basic-data").addClass("hidden");
                $("#check-email").removeClass("hidden");
            });

            $("#resend").click(function() {
            	$(".resend").addClass("hidden");
            	$("#resend-loading").removeClass("hidden");
                sendverificationemail(user, function(dateobj) {
					if (dateobj === false || dateobj == null) {
						$("#resend").addClass("hidden");
						$("#resend-error").removeClass("hidden");
						//error

					} else {
						startResendTimer();

						$(".sent-date").text(getHumanDate(dateobj));
						$(".orig-email").text(user.providerData[0].email);
					}
                });

            })
        } else {
            if (getQuery("key") != "test") {
                $("#main-box").remove();
                $("#scripts").remove();
                $("#loading").addClass("hidden");
                $("#nokey-box").removeClass("hidden");
            } else {
                $("#loading").addClass("hidden");
                $("#main-box").removeClass("hidden");
                $("#basic-data").removeClass("hidden");
            }
        }
    });
    var resendInterval;
    function startResendTimer(firstTime, secondsLeft) {
		firstTime = firstTime || false;
    	//if firstTime is true, we assume the verification email was sent but not resent(the account was just created),
        //so we show a slightly different message.
		secondsLeft = secondsLeft || 60;
		$(".resend-time-remaining").text("Synchronizing...");
		$(".resend-plural").removeClass("hidden");
		$(".resend").addClass("hidden");
		if (firstTime) {
			$("#resend-countdown").removeClass("hidden");
        } else {
			$("#resend-success").removeClass("hidden");
        }
		clearInterval(resendInterval);
		resendInterval = setInterval(function(){
			if (secondsLeft == 1) {
				$(".resend-plural").addClass("hidden");
            } else if (secondsLeft == 0) {
				$(".resend-plural").removeClass("hidden");
            }
			$(".resend-time-remaining").text(secondsLeft);
			secondsLeft --;
			if (secondsLeft < 0) {
				clearInterval(resendInterval);

				$(".resend").addClass("hidden");
				$("#resend").removeClass("hidden");
			}
		}, 1000);
    }
    function getHumanDate(dateobj) {
        var date = dateobj.date;
        if (typeof date === "string") {
            date = new Date(date);
        }
        console.log(dateobj);
        var days = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];//for clarity
        var months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"]
        var day = days[date.getDay()];
        var dayOfMonth = date.getDate();
        var month = months[date.getMonth()];
        var year = date.getFullYear();
        var time = date.toLocaleTimeString("en-US");
        var timediffhour = "" + Math.floor(dateobj.timezone.offset / 60);
        if (timediffhour.length === 1) {
			timediffhour = "0" + timediffhour;
        }
		var timediffminutes = "" + (dateobj.timezone.offset % 60);
		if (timediffminutes.length === 1) {
			timediffminutes = "0" + timediffminutes;
		} else if (timediffminutes.length === 0) {
			timediffminutes = "00" + timediffminutes;
		}
		var iata = dateobj.timezone.iata;
		return day + ", " + month + " " + dayOfMonth + ", " + year + " at " + time + " UTC-" + timediffhour + timediffminutes + "(" + iata + ")";


    }
    function sendverificationemail(user, callback) {
    	//continue url not supported because the user usually does not create an account spontaneously(in the middle of a session) due to create links.
        /*var actionCodeSettings = {
            url: "https://www.t485.org/?email=" + firebase.auth().currentUser.email + ((getQuery("continue") != "" && getQuery("continue") != null) ? "&redir=" + getQuery("continue") : "")

        };*/
        user.sendEmailVerification(/*actionCodeSettings*/)
            .then(function () {
                console.log(user);
                // Verification email sent.

                var date = new Date();
                var dateobj = {
                    date:(date + ""),// + "" is IMPORTANT!! otherwise date is pushed to
					// Firebase as undefined even though console.log prints it as a string.
                    timezone: {
                        iata: Intl.DateTimeFormat().resolvedOptions().timeZone,//IANA time zone (e.g. America/Los_Angeles)
                        offset: date.getTimezoneOffset()//in minutes
                    }
                }

                //console.log(firebase.database().ref("/users/" + user.uid + "/latestverificationemail/").set({date}));
                firebase.database().ref("/users/" + user.uid + "/latestverificationemail/").set(dateobj).catch(function(error) {
                    console.log(error);

                });
                firebase.database().ref("/users/" + user.uid + "/verificationemailhistory/").push(dateobj).catch(function(error) {
                    console.log(error);
                });
                if (callback) {
					callback(dateobj);
				}
            }).catch(function (error) {
            	console.log(error);
                $("#loading").addClass("hidden");
                $("#main-box").removeClass("hidden");
                $("#unknown-error-text").text(error.code);
                $("#basic-data").addClass("hidden");
                $("#check-email").addClass("hidden");
                $("#unknown-error").removeClass("hidden");
                callback(false);

        });

    }
    $("#next-btn").click(function () {
        $("#basic-data .form-control").removeClass("is-invalid")
        var email = $("#email").val();
        var password = $("#password").val();
        var confpassword = $("#confirm-password").val();
        $(".orig-email").text(email);
        $("#error").html("");
        var invalid = false;
        if (email.replaceAll(" ", "") == "" || email == null) {
            $("#em-validation-inuse").addClass("hidden");
            $("#pw-validation-none").removeClass("hidden");
            $("#email").addClass("is-invalid");
            invalid = true;
        }
        if (password.replaceAll(" ", "") == "" || password == null) {
			$("#password").val("");
			$("#confirm-password").val("");
            $("#pw-validation-strength").addClass("hidden");//message when weak password
            $("#pw-validation-none").removeClass("hidden");//validation message when no password
            $("#password").addClass("is-invalid");
            invalid = true;
        }
        if (password !== confpassword) {
			$("#password").val("");
			$("#confirm-password").val("");
            $("#confirm-password").addClass("is-invalid")
            invalid = true;
        }
        if (!invalid) {
            firebase.auth().createUserWithEmailAndPassword(email, password).catch(function (error) {
                var errortext = "";
                switch (error.code) {
                    case "auth/email-already-in-use":
                        $("#em-validation-invalid").addClass("hidden");
                        $("#em-validation-inuse").removeClass("hidden");
                        $("#email").addClass("is-invalid");
                        errortext = "";
                        break;
                    case "auth/invalid-email":
                        $("#em-validation-inuse").addClass("hidden");
                        $("#em-validation-invalid").removeClass("hidden");
                        $("#email").addClass("is-invalid");
                        break;
                    case "auth/weak-password":
						$("#password").val("");
						$("#confirm-password").val("");
                        //errortext = "The password is not strong enough. Try adding uppercase and lowercase letters, numbers, and special symbols.";
                        $("#pw-validation-strength").removeClass("hidden");
                        $("#pw-validation-none").addClass("hidden");
                        $("#password").addClass("is-invalid");
                        break;
                    default:
                        errortext = "An unknown error occurred. (Code: " + error.code + ")";
                }
                if (errortext != null && errortext !== "") {
                    $("#error").html("Error: " + errortext);
                }
            });
        }
    });


</script>

	 
</body>
