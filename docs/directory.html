<!DOCTYPE html>

<html lang="en">

<head>
	
		<meta charset="utf-8">
		<meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport">
		<meta content=" The official Boy Scout Troop 485 website. " name="description">
	
	 
	
		<title>Troop 485 - Directory</title>
		
	
	
		<!-- Bootstrap core CSS -->
		<link href="/css/bootstrap.min.css" rel="stylesheet">
		<!-- Custom fonts for this template -->
		<link href="https://fonts.googleapis.com/css?family=Raleway:100,100i,200,200i,300,300i,400,400i,500,500i,600,600i,700,700i,800,800i,900,900i"
			rel="stylesheet">
		<link href="https://fonts.googleapis.com/css?family=Lora:400,400i,700,700i" rel="stylesheet">
		<!-- Custom styles for this template -->
		<link href="/css/theme.css" rel="stylesheet">
		<link href="/css/t485.css" rel="stylesheet">
	
	
		<!-- Favicons -->
		<link rel="apple-touch-icon" sizes="152x152" href="/favicons/apple-touch-icon-152x152.png">
		<link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon-180x180.png">
		<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
	
	
<link href="/css/bootstrap-select.min.css" rel="stylesheet">
<style>
.table-wrapper,
.row,
.box {
    width: 100%; 
    height:100%;
}

#table {
    display: block !important;
    width:100%;
    overflow:auto;
    
}
/* always show scroll bar 

#table::-webkit-scrollbar {
    -webkit-appearance: none;
}

#table::-webkit-scrollbar:vertical {
    width: 11px;
}

#table::-webkit-scrollbar:horizontal {
    height: 11px;
}

#table::-webkit-scrollbar-thumb {
    border-radius: 8px;
    border: 2px solid white; 
    background-color: rgba(0, 0, 0, .5);
}
*/
</style>

	
		<script>
			try {
				localStorage.setItem('firebaseErrorTest', 'test');
			}
			catch (e) {
				console.log(e)
				if (e.message === 'The quota has been exceeded.') {
					// using Safari(desktop & iOS) or Chrome(iOS) w/ private, localStorage not supported
					// firebase will throw error, so better to alert user now
					alert("Private browsing is not supported on Safari or the Chrome IOS app. " + 
					"Turn off private browsing or use a supported private browsing app.");
				}
				throw 'notEnoughLocalStorage';
			}
		</script>
	
</head>

<body>
	
		<div class="text-center">
			<a href="/">
				<img src="/img/header.png" alt="Boy Scout Troop 485" id="header">
			</a>
		</div>
	
	
		

		<div id="alertBox">
		</div>
	
	
		<!-- Navigation -->


		<nav class="navbar navbar-expand-lg navbar-light py-lg-4" id="navbar">
			<div class="container">
				<a class="navbar-brand text-uppercase text-expanded font-weight-bold d-lg-none" href="/">Troop 485</a>
				<button aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation" class="navbar-toggler"
					data-target="#navbarResponsive" data-toggle="collapse" type="button">
					<span class="navbar-toggler-icon"></span>
				</button>

				<div class="collapse navbar-collapse" id="navbarResponsive">
					<ul class="navbar-nav mx-auto">
					
						
						<li class="nav-item px-lg-4">
							<a class="nav-link text-uppercase text-expanded" href="/">Home</a>
						</li>

						<li class="nav-item px-lg-4">
							<a class="nav-link text-uppercase text-expanded" href="/calendar.html">Calendar</a>
						</li>
						<li class="nav-item px-lg-4">
							<a class="nav-link text-uppercase text-expanded" href="/directory.html">Directory</a>
						</li>
						<li class="nav-item px-lg-4">
							<a class="nav-link text-uppercase text-expanded" href="/event-pages.html">Event Pages</a>
						</li>


						<li class="nav-item dropdown">
							<a aria-expanded="false" aria-haspopup="true" class="nav-link dropdown-toggle text-uppercase text-expanded" data-toggle="dropdown"
								href="#" id="account-dropdown" role="button">Account</a>

							<div aria-labelledby="account-dropdown" class="dropdown-menu">
								<h6 class="dropdown-header">You are not logged in.</h6>
								<a class="dropdown-item" href="/account/login.html">Login</a>
							</div>
						</li>
					</ul>
				</div>
			</div>
		</nav>
	
	

		<div class="container">
			
<div class="row">
    <div class="box">
        <div class="col-lg-12 table-wrapper">	
            <h2 class="primary-heading">
                Directory
            </h2>
            <div id="directory-list">
                <b>Search:</b>
                <input type="text" class="form-control fuzzy-search" id="search" placeholder="Search by name, phone number, slack username, etc.">
                <form class="pt-1">
                    <div class="row">
                        <div class="col">
                        <b>Sort by:</b>
                            <select class="selectpicker form-control" data-live-search="true" id="sortby-select">
                                <optgroup label="Scout">
                                    <option value="0">Scout's First Name</option>
                                    <option value="1" selected>Scout's Last Name <i class="fas fa-sort-up"></i></option>
                                    <option value="2">Patrol</option>
                                    <option value="3">Scout's E-mail</option>
                                    <option value="4">Scout's Home Phone</option>
                                    <option value="5">Slack Username</option>
                                    <option value="6">Date Joined Troop 485</option>
                                    <option value="7">Active</option>
                                    <option value="8">Wilderness First Aid Trained</option>
                                    <option value="9">School Attending</option>
                                    <option value="10">Scout's Cell Phone</option>
                                </optgroup>
                                <optgroup label="Father">
                                    <option value="11">Father's First Name</option>
                                    <option value="12">Father's Last Name</option>
                                    <option value="13">Father's Cell Phone</option>
                                    <option value="14">Father's E-mail</option>
                                    <option value="15">Father's Slack Username</option>
                                </optgroup>
                                <optgroup label="Mother">
                                    <option value="16">Mother's First Name</option>
                                    <option value="17">Mother's Last Name</option>
                                    <option value="18">Mother's Cell Phone</option>
                                    <option value="19">Mother's E-mail</option>
                                    <option value="20">Mother's Slack Username</option>
                                </optgroup>
                            </select>
                        </div>
                        <div class="col">
                            <b>Sort order:</b>
                            <select class="selectpicker form-control" id="sortorder-select">
                                <option value="asc">Ascending</option>
                                <option value="desc">Descending</option>
                            </select>
                        </div>
                        <div class="col">
                        <b>Show:</b>
                            <select class="selectpicker form-control" multiple id="filter-select" data-live-search="true" data-actions-box="true">
                                <optgroup label="Scout">
                                    <option value="0" selected>Scout's First Name</option>
                                    <option value="1" selected>Scout's Last Name</option>
                                    <option value="2" selected>Patrol</option>
                                    <option value="3" selected>Scout's E-mail</option>
                                    <option value="4" selected>Scout's Home Phone</option>
                                    <option value="5" >Slack Username</option>
                                    <option value="6">Date Joined Troop 485</option>
                                    <option value="7">Active</option>
                                    <option value="8">Wilderness First Aid Trained</option>
                                    <option value="9">School Attending</option>
                                    <option value="10" selected>Scout's Cell Phone</option>
                                </optgroup>
                                <optgroup label="Father">
                                    <option value="11">Father's First Name</option>
                                    <option value="12">Father's Last Name</option>
                                    <option value="13">Father's Cell Phone</option>
                                    <option value="14">Father's E-mail</option>
                                    <option value="15">Father's Slack Username</option>
                                </optgroup>
                                <optgroup label="Mother">
                                    <option value="16">Mother's First Name</option>
                                    <option value="17">Mother's Last Name</option>
                                    <option value="18">Mother's Cell Phone</option>
                                    <option value="19">Mother's E-mail</option>
                                    <option value="20">Mother's Slack Username</option>
                                </optgroup>
                            </select>
                            
                        </div>
                    </div>
                    
                    </form>
                
                <br>
                <p id="modified-settings" class="hidden"> Modified search/sort settings saved in URL. <a href="?#">Reset to default settings</a>. </p>
                <p>Select a row to view all information about that scout:</p>
                <div id="table-secondscrollbar-wrapper">
                    <div class="table-secondscrollbar-div"></div>
                </div>
                <div id="table-wrapper">
                    <table class="table table-hover" id="table">
                        <thead>
                            <tr>
                                
                            <th scope="col" class="col0" data-col="0">Scout's First Name</th>
                            <th scope="col" class="col1" data-col="1">Scout's Last Name</th>
                            <th scope="col" class="col2" data-col="2">Patrol</th>
                            <th scope="col" class="col3" data-col="3">Scout's E-mail:</th>
                            <th scope="col" class="col4" data-col="4">Scout's Home Phone</th>
                            <th scope="col" class="col5" data-col="5">Slack Username</th>
                            <th scope="col" class="col6" data-col="6">Date Joined Troop 485</th>
                            <th scope="col" class="col7" data-col="7">Active (Y)es/ (R)arely/ (N)o</th>
                            <th scope="col" class="col8" data-col="8">Wilderness First Aid Trained</th>
                            <th scope="col" class="col9" data-col="9">School Attending</th>
                            <th scope="col" class="col10" data-col="10">Scout's Cell Phone</th>
                            <th scope="col" class="col11" data-col="11">Father's First Name</th>
                            <th scope="col" class="col12" data-col="12">Father's Last Name</th>
                            <th scope="col" class="col13" data-col="13">Father's Cell Phone</th>
                            <th scope="col" class="col14" data-col="14">Father's E-mail</th>
                            <th scope="col" class="col15" data-col="15">Father's Slack Username or None</th>
                            <th scope="col" class="col16" data-col="16">Mother's First Name</th>
                            <th scope="col" class="col17" data-col="17">Mother's Last Name</th>
                            <th scope="col" class="col18" data-col="18">Mother's Cell Phone</th>
                            <th scope="col" class="col19" data-col="19">Mother's E-mail</th>
                            <th scope="col" class="col20" data-col="20">Mother's Slack Username or None</th>
                            </tr>
                        </thead>
                        <tbody id="dir-body" class="list">
                            <tr id="loading-text"><td colspan="21">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <p>View/Edit the troop directory spreadsheet on <a target="_blank" class="link-google-sheet-dir">Google Sheets</a>.</p>
        </div>
    </div>
</div>

		</div>
	
	

		<footer class="footer text-faded text-center py-5">
			<div class="container">
				<p class="m-0 small">Copyright &copy; 2006-2018 Troop 485, Silicon Valley Monterey Bay Council, Boy Scouts of America.</p>
			</div>
		</footer>
	
	
	
		<script src="https://www.gstatic.com/firebasejs/5.0.4/firebase-app.js">
		</script>
		<script src="https://www.gstatic.com/firebasejs/5.0.4/firebase-auth.js">
		</script>
		<script src="https://www.gstatic.com/firebasejs/5.0.4/firebase-database.js">
		</script>
		<script src="https://www.gstatic.com/firebasejs/5.0.4/firebase-storage.js">
		</script>
		<!-- <script src="https://www.gstatic.com/firebasejs/5.0.4/firebase-firestore.js"></script> -->
		<!-- <script src="https://www.gstatic.com/firebasejs/5.0.4/firebase-messaging.js"></script> -->
		<!-- <script src="https://www.gstatic.com/firebasejs/5.0.4/firebase-functions.js"></script> -->

		<script>
			// Initialize Firebase
			var config = {
				apiKey: "AIzaSyB-ly8ax35aWTAGhX2UDVuYxPSDlAU8kMk",
				authDomain: "t485-main.firebaseapp.com",
				databaseURL: "https://t485-main.firebaseio.com",
				projectId: "t485-main",
				storageBucket: "t485-main.appspot.com",
				messagingSenderId: "368513727602"
			};
			firebase.initializeApp(config);
		</script>
	
	
		<!-- Bootstrap core JavaScript -->

		<script src="/js/jquery.min.js">
		</script>
		<script src="/js/popper.min.js">
		</script>
		<script src="/js/bootstrap.min.js">
		</script>
		<script src="/js/t485.js">
		</script>
	
	
<script src="/fonts/fontawesome/fontawesome.js"></script>
<script src="/fonts/fontawesome/solid.js"></script>
<script src="/js/list.min.js"></script>
<script src="/js/bootstrap-select.min.js"></script>

<script>
    var list = false;//false means uninitiated
    var scoutArrayKeymap = [["scout", "firstName"], ["scout", "lastName"], ["scout", "email"], ["scout", "homePhone"], ["scout", "slack"], ["scout", "joinDate"], ["scout", "active"], ["scout", "WFATrained"], ["scout", "school"], ["scout", "cellPhone"],
                            ["father", "firstName"], ["father", "lastName"], ["father", "cellPhone"], ["father", "email"], ["father", "slackUsername"],
                            ["mother", "firstName"], ["mother", "lastName"], ["mother", "cellPhone"], ["mother", "email"], ["mother", "slackUsername"]];
            
    firebase.database().ref("/directory/keys/").once("value").then(function(snapshot){
        var keys = snapshot.val();
        $(".link-google-sheet-dir").attr("href", `https://docs.google.com/spreadsheets/d/${keys.id}/edit`);

        rangeString = ``;
        for (i = 0; i < keys.sheets.length; i ++) {
            rangeString += `ranges=${keys.sheets[i]}!A2:T&`
        }
        $.ajax({
            url:`https://sheets.googleapis.com/v4/spreadsheets/${keys.id}/values:batchGet/?${rangeString}majorDimension=ROWS&valueRenderOption=FORMATTED_VALUE&key=${keys.api}`,
            method:"GET",
            dataType:"json"
        }).done(function(data){
            $("#loading-text").addClass("hidden");
            var ranges = data.valueRanges;
            var scoutArrayKeymap = [["scout", "firstName"], ["scout", "lastName"], ["scout", "email"], ["scout", "homePhone"], ["scout", "slack"], ["scout", "joinDate"], ["scout", "active"], ["scout", "WFATrained"], ["scout", "school"], ["scout", "cellPhone"],
                            ["father", "firstName"], ["father", "lastName"], ["father", "cellPhone"], ["father", "email"], ["father", "slackUsername"],
                            ["mother", "firstName"], ["mother", "lastName"], ["mother", "cellPhone"], ["mother", "email"], ["mother", "slackUsername"]];
            var scouts = [];
            var row = 0;
            for (i = 0; i < ranges.length; i ++) {
                var values = ranges[i].values;
                var patrol = keys.sheets[i];
                //loop through each cell of each row and populate it with the data
                for (j = 0; j < values.length; j ++) {
                    var line = "<tr class='table-row'>";

                    //also populate the scouts object
                    scouts[row] = {
                        scout:{},
                        father:{},
                        mother:{}
                    };
                    var cell = 0;
                    for (k = 0; k < values[j].length + 1; k ++) {//+1 for patrol
                        
                        if (k == 2) {//before the third iteration
                            if (getColVisibility(k)) {
                                hidden = "";
                            } else {
                                hidden = "hidden";
                            }
                            line += "<td class='col" + k + " " + hidden + "' data-col='" + k + "' data-row='" + row + "'>" + patrol + "</td>";
                            scouts[row][scoutArrayKeymap[cell][0]][scoutArrayKeymap[cell][1]] = patrol;
                            
                            continue;
                        }
                        if (getColVisibility(k)) {
                            hidden = "";
                        } else {
                            hidden = "hidden";
                        }
                        
                        line += "<td class='col" + k + " " + hidden + "' data-col='" + k + "' data-row='" + row + "'>" + values[j][cell] + "</td>";
                        
                        scouts[row][scoutArrayKeymap[cell][0]][scoutArrayKeymap[cell][1]] = values[j][cell];
                        cell ++;
                        
                    }
                    line += "</tr>";
                    row ++;
                    $("#dir-body").append(line);
                }
            }
            $("#table").on("click", ".table-row", function (e) {
                var id = $(e.target).attr("data-row");
                window.location.hash = id;
            });
            
            $(window).on("hashchange", function() {
                onhashchange(scouts, keys);
            });
            $(document).ready(function() {
                onhashchange(scouts, keys);
            });
            //init list.js
            var valueNames = [];
            for (i = 0; i < values[0].length + 1; i ++) {//+1 for the patrol row
                valueNames.push("col" + i);
            }
            var options = {
                valueNames: valueNames
            };

            list = new List('directory-list', options);
            //when search data is stored in a query string it is loaded before the list, therefore
            //we must manually call search and sort again to only show the results of the search.
            list.search($("#search").val());
            list.sort("col" + $("#sortby-select").val(), { order: $("#sortorder-select").val() });
            $("#sortby-select, #sortorder-select").change(function() {
                list.sort("col" + $("#sortby-select").val(), { order: $("#sortorder-select").val() });
                setURLQuery(setQuery("sortby", $("#sortby-select").val()));
                setURLQuery(setQuery("sortorder", $("#sortorder-select").val()));
            });
        });
        
    });
    
    function getSlackLink(username, slackToken, callback, passthroughData) {
        firebase.database().ref("/directory/slackUID/").once("value").then(function(snapshot){
            var data = snapshot.val();
            var encodedUsername = encodeUsername(username);
            
            if (data != null && data[encodedUsername] != null && data[encodedUsername] != undefined) {
                //third parameter(boolean) is for debugging, it states whether the slack api was used.
                callback(data[encodedUsername], username, false, passthroughData);
                return;
            } else {
                $.ajax({
                    url:`https://slack.com/api/users.list?token=${slackToken}`,
                    method:"GET",
                    dataType:"json"
                }).done(function(userlistdata){
                    var userlist = userlistdata.members;
                    var updates = {};
                    
                    for (i = 0; i < userlist.length; i ++) { 
                        if (userlist[i].deleted) {
                            continue;
                        }
                        if (userlist[i].profile.display_name != "" && userlist[i].profile.display_name != undefined) {
                            displayName = userlist[i].profile.display_name;
                        } else {
                            displayName = userlist[i].profile.real_name;
                        }
                        
                        updates[encodeUsername(displayName)] = userlist[i].id;
                        if (displayName == username) {
                            callback(userlist[i].id, username, truea, passthroughData);
                        }
                    }
                    firebase.database().ref("/directory/slackUID/").update(updates);
                });
            }
        });
    }
    function encodeUsername(username) {
        //modified encodeURIComponent
        var result = encodeURIComponent(username);//start by encoding URI chars
        //then encode .
        return result.replaceAll(".", "%2E");//%2E is UTF-8 for .(period)
    }
    function decodeUsername(encodedusername) {
        //decodeURIComponent decodes ALL UTF-8, not just the stuff encodeURIComponent encodes, so it 
        //also decodes %2E, or .(period).
        //This function exists just for clarity.
        return decodeURIComponent(encodedusername);
        
    }
    function onhashchange(scouts, keys) {
        if (window.location.hash == "") {
            return;
        }
        var id = parseInt(window.location.hash.substring(1), 10);
        if (Number.isNaN(id) || id < 0 || id >= scouts.length) {
            return;
        }

        // get the slack usernames for the scout and their parents
        var relationshipKeymap = ["scout", "father", "mother"];
        for (i = 0; i < 3; i ++) {
            console.log(".infoModal-" + relationshipKeymap[i] + "SlackDMLink")
            console.log(scouts[id][relationshipKeymap[i]].slack);
            if (scouts[id][relationshipKeymap[i]].slack == "" || scouts[id][relationshipKeymap[i]].slack == undefined) {
                console.log(".infoModal-" + relationshipKeymap[i] + "SlackUsername");
                $(".infoModal-" + relationshipKeymap[i] + "SlackDMLink").attr("href", null);
                $(".infoModal-" + relationshipKeymap[i] + "SlackUsername").html("<i>Not listed in spreadsheet</i>");
                $(".infoModal-" + relationshipKeymap[i] + "SlackDMLoadingText").text("");
            } else if (scouts[id][relationshipKeymap[i]].slack.toLowerCase() == "none") {
                console.log(".infoModal-" + relationshipKeymap[i] + "SlackUsername");
                $(".infoModal-" + relationshipKeymap[i] + "SlackDMLink").attr("href", null);
                $(".infoModal-" + relationshipKeymap[i] + "SlackUsername").html("<i>None</i>");
                $(".infoModal-" + relationshipKeymap[i] + "SlackDMLoadingText").text("");
            } else {
                $(".infoModal-" + relationshipKeymap[i] + "SlackUsername").text("@" + scouts[id].scout.slack);
                $(".infoModal-" + relationshipKeymap[i] + "SlackDMLoadingText").text("(profile loading...)");
                getSlackLink(scouts[id][relationshipKeymap[i]].slack, keys.slackToken, function(id, username, slackApiCalled, i) {
                    
                    $(".infoModal-" + relationshipKeymap[i] + "SlackDMLink").attr("href", "https://t485.slack.com/messages/team/" + id);
                    $(".infoModal-" + relationshipKeymap[i] + "SlackDMLoadingText").text("");
                }, i);
                
            }
        }
        var traitText;
        var notListedText = "Not listed in spreadsheet.";
        
        for (var trait = 0; trait < scoutArrayKeymap.length; trait ++) {

            traitText = scouts[id][scoutArrayKeymap[trait][0]][scoutArrayKeymap[trait][1]];
            console.log(traitText);
            $(".infoModal-" + scoutArrayKeymap[trait][0] + 
                scoutArrayKeymap[trait][1].substring(0,1).toUpperCase() + scoutArrayKeymap[trait][1].substring(1) + "Link")
                .attr("href", null);//clear the link first
            //for some traits, we add additional attributes(such as changing emails into email links) or change Y to Yes and N to No
            if (traitText == undefined || traitText == "") {
                traitText = notListedText;
            } else if (scoutArrayKeymap[trait][1] == "active" || scoutArrayKeymap[trait][1] == "WFATrained") {
                traitText = traitText == "Y" || traitText == "y" ? "Yes" : traitText == "N" || traitText == "n" ? "No" : traitText == "R" || traitText == "r" ? "Rarely" : traitText
            } else if (scoutArrayKeymap[trait][1] == "email" || scoutArrayKeymap[trait][1] == "Email") {
                 $(".infoModal-" + scoutArrayKeymap[trait][0] + 
                scoutArrayKeymap[trait][1].substring(0,1).toUpperCase() + scoutArrayKeymap[trait][1].substring(1) + "Link")
                .attr("href", "mailto:" + traitText);
            } else if (scoutArrayKeymap[trait][1] == "cellPhone" || scoutArrayKeymap[trait][1] == "CellPhone" || 
                scoutArrayKeymap[trait][1] == "homePhone" || scoutArrayKeymap[trait][1] == "HomePhone") {
                 $(".infoModal-" + scoutArrayKeymap[trait][0] + 
                scoutArrayKeymap[trait][1].substring(0,1).toUpperCase() + scoutArrayKeymap[trait][1].substring(1) + "Link")
                .attr("href", (traitText.replace(/\D/g,"") == "" ? null : "tel:" + traitText.replace(/\D/g,"")));
                console.log((traitText.replace(/\D/g,"") == "" ? null : "tel:" + traitText.replace(/\D/g,"")))
                //remove all non-digit characters
                //if it's not a phone number (e.g. "N/A" or "None"), don't link it or remove the characters.
            }
            //str for testing
            var str = scoutArrayKeymap[trait][1];
            console.log(".infoModal-" + scoutArrayKeymap[trait][0] + 
                scoutArrayKeymap[trait][1].substring(0,1).toUpperCase() + scoutArrayKeymap[trait][1].substring(1))
            $(".infoModal-" + scoutArrayKeymap[trait][0] + 
                scoutArrayKeymap[trait][1].substring(0,1).toUpperCase() + scoutArrayKeymap[trait][1].substring(1))
                .text(traitText);
        }
        for (i = 0; i < relationshipKeymap.length; i ++) {
            if (scouts[id][relationshipKeymap[i]].firstName == undefined || scouts[id][relationshipKeymap[i]].firstName == "" || scouts[id][relationshipKeymap[i]].lastName == undefined || scouts[id][relationshipKeymap[i]].lastName == "") {
                $(".infoModal-" + relationshipKeymap[i] + "FullNameElement").addClass("hidden");
                $(".infoModal-" + relationshipKeymap[i] + "FirstNameElement").removeClass("hidden");
                $(".infoModal-" + relationshipKeymap[i] + "LastNameElement").removeClass("hidden");
            } else {
                $(".infoModal-" + relationshipKeymap[i] + "FullName").text(scouts[id][relationshipKeymap[i]].firstName + " " + scouts[id][relationshipKeymap[i]].lastName);
            }
        }
        $("#infoModal").modal("show");
            
    }
    function getColVisibility(col) {
        
        var selected = $("#filter-select").val().map(str => parseInt(str, 10));
        
        return selected.indexOf(col) > -1;
    }
    function filterselectchange(){
        var selected = $("#filter-select").val().map(str => parseInt(str, 10));
        var show = [];
        for (i = 0; i < 21; i ++) {
            if (selected.indexOf(i) > -1) {
                 $(".col" + i).removeClass("hidden");
                 show.push(i);
                 
            } else {
                 $(".col" + i).addClass("hidden");
            }
           
        }
        var preset = [0, 1, 2, 3, 4, 10];
        var usingPreset = false;
        
        if (selected.length == preset.length) {
            for (i = 0; i < preset.length; i ++) {
                if (!(preset.indexOf(selected[i]) > -1)) {
                    
                    break;
                } else if (i == preset.length - 1) {
                    
                    usingPreset = true;
                } else {
                   
                    
                }
            }
        }
        
        if (!usingPreset) {
            setURLQuery(setQuery("filter", show.join(",")));
        } else {
            
            setURLQuery(setQuery("filter", null));
        }
        
    }
    $(document).ready(function() {
        processURLOptions();
        $("#infoModal").on("hide.bs.modal", function() {
            //remove hash
            history.pushState("", document.title, window.location.pathname + window.location.search);

        });
    })
    $("#filter-select").change(filterselectchange);
    function setURLQuery(fullQueryString) {
        
        var newurl = window.location.protocol + "//" + window.location.host + window.location.pathname + fullQueryString + window.location.hash;
        if (history.pushState) {
            window.history.pushState({path:newurl},'',newurl);
        } else {
            //window.location.href = newurl;
        }
        checkDefaultOptions();
    }
    function processURLOptions() {
        var preset = {//defaults
            sortby:1,
            sortorder:"asc",
            filter:[0, 1, 2, 3, 4, 10]
        };
        
        var options = {
            filter:getQuery("filter") && getQuery("filter").length > 0 ? getQuery("filter").split(",").map( str => parseInt(str, 10)) : undefined,
            sortby:parseInt(getQuery("sortby"), 10),
            sortorder:getQuery("sortorder")
        }
        checkDefaultOptions();
        setOptions(merge(preset, options));
    } 
    function checkDefaultOptions() {
        var preset = {//defaults
            sortby:1,
            sortorder:"asc",
            filter:[0, 1, 2, 3, 4, 10]
        };
        var options = {
            filter:getQuery("filter") && getQuery("filter").length > 0 ? getQuery("filter").split(",").map( str => parseInt(str, 10)) : undefined,
            sortby:Number.isInteger(parseInt(getQuery("sortby"), 10))? parseInt(getQuery("sortby"), 10) : getQuery("sortby"),
            sortorder:getQuery("sortorder")
        }
        var match = {//easier to do logic here in ternary operator than in one if statement
            filter:options.filter == preset.filter || options.filter == "" || options.filter == null,
            sortby:options.sortby == preset.sortby || options.sortby == "" || options.sortby == null,
            sortorder:options.sortorder == preset.sortorder || options.sortorder == "" || options.sortorder == null
        }
        //console.log(options.sortby);
        //console.log(JSON.parse(JSON.stringify(match)));
        if (match.filter && match.sortby && match.sortorder) {
            //console.log("hidden");
            //remove search 
            history.pushState("", document.title, window.location.pathname + window.location.hash);
            $("#modified-settings").addClass("hidden");
        } else {
            //console.log("not hidden");
            $("#modified-settings").removeClass("hidden");
        }
    }
    function merge(old, newobj) {
        for (var key in newobj) {
            if (newobj.hasOwnProperty(key) && newobj[key] !== null && newobj[key] !== undefined && newobj[key] != "") old[key] = newobj[key];
        }
        return old;
    }
    $("#search").keyup(function() {
        setURLQuery(setQuery("query", encodeURIComponent($("#search").val())));
    });
    function setOptions(options) {
        for (i = 0; i <= 20; i ++) {
            
            $("#filter-select option[value=" + i + "]").attr("selected", (options.filter.indexOf(i) > -1 ? "" : null));
        }
        $("#filter-select").selectpicker("refresh");
        filterselectchange();
        
        for (i = 0; i <= 20; i ++) {
            
            $("#sortby-select option[value=" + i + "]").attr("selected", (options.sortby == i ? "" : null));
        }
        $("#sortby-select").selectpicker("refresh");
        $("#sortby-select").trigger("change");
        
        $("#sortorder-select option[value=" + options.sortorder + "]").attr("selected", "");
        $("#sortorder-select option[value=" + (options.sortorder == "asc" ? "desc" : "asc") + "]").attr("selected", null);
        $("#sortorder-select").selectpicker("refresh");
        $("#sortorder-select").trigger("change");

        if (list) {
            //by default list is false and therefore this code will not run
            //on the off chance that the list object is initiated before this code runs
            //we must re-triggger the search to show only search results.
            list.search($("#search").val());
            list.sort("col" + $("#sortby-select").val(), { order: $("#sortorder-select").val() });
        }

        $("#search").val(getQuery("query"));
        $("#search").trigger("keyup");

    }
    
    //If on moible, tell seectpicker to default to system default select.
    if( /Android|webOS|iPhone|iPad|iPod|BlackBerry/i.test(navigator.userAgent) ) {
        $('.selectpicker').selectpicker('mobile');
    }
</script>

	
<div class="modal fade" id="infoModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title infoModal-scoutFullName">Loading...</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <ul class="list-group list-group-flush">
                    
                    
                    <li class="list-group-item nfoModal-scoutFullNameElement"> <b>Scout's Name:</b> <span class="infoModal-scoutFullName"></span>	</li>
                    <li class="list-group-item infoModal-scoutFirstNameElement hidden "> <b>Scout's First Name:</b> <span class="infoModal-scoutFirstName"></span>	</li>
                    <li class="list-group-item infoModal-scoutLastNameElement hidden"> <b>Scout's Last Name:</b> <span class="infoModal-scoutLastName"></span>	</li>
                    <li class="list-group-item"> <b>Scout's E-mail:</b>	<a class="infoModal-scoutEmail infoModal-scoutEmailLink"></a></li>
                    <li class="list-group-item"> <b>Scout's Home Phone:</b>	<a class="infoModal-scoutHomePhone infoModal-scoutHomePhoneLink"></a></li>
                    <li class="list-group-item">
                        <b>Scout's Slack:</b> <a class="infoModal-scoutSlackDMLink" target="_blank"><span class="infoModal-scoutSlackUsername"></span><span class="infoModal-scoutSlackDMLoadingText"></span></a>
                    </li>
                    
                    <li class="list-group-item"> <b>Scout's Cell Phone:</b> <a class="infoModal-scoutCellPhone infoModal-scoutCellPhoneLink"></a></li>
                    <li class="list-group-item infoModal-fatherFullNameElement"> <b>Father's Name: </b><span class="infoModal-fatherFullName"></span></li>
                    <li class="list-group-item infoModal-fatherFirstNameElement hidden"> <b>Father's First Name: </b><span class="infoModal-fatherFirstName"></span></li>
                    <li class="list-group-item infoModal-fatherLastNameElement hidden"> <b>Father's Last Name: </b><span class="infoModal-fatherLastName"></span></li>
                    <li class="list-group-item"> <b>Father's Cell Phone: </b><a class="infoModal-fatherCellPhone infoModal-fatherCellPhoneLink"></a></li>
                    <li class="list-group-item"> <b>Father's E-mail:	</b><a class="infoModal-fatherEmail infoModal-fatherEmailLink"></a></li>
                    <li class="list-group-item"> 
                        <b>Father's Slack:	</b><a class="infoModal-fatherSlackDMLink" target="_blank"><span class="infoModal-fatherSlackUsername">loading</span><span class="infoModal-fatherSlackDMLoadingText">loading</span></a>
                    </li>
                    <li class="list-group-item infoModal-motherFullNameElement "> <b>Mother's Name:	</b><span class="infoModal-motherFullName"></span></li>
                    <li class="list-group-item infoModal-motherFirstNameElement hidden "> <b>Mother's First Name:	</b><span class="infoModal-motherFirstName"></span></li>
                    <li class="list-group-item infoModal-motherLastNameElement hidden"> <b>Mother's Last Name:	</b><span class="infoModal-motherLastName"></span></li>
                    <li class="list-group-item"> <b>Mother's Cell Phone:	</b><a class="infoModal-motherCellPhone infoModal-motherCellPhoneLink"></a></li>
                    <li class="list-group-item"> <b>Mother's E-mail:	</b><a class="infoModal-motherEmail infoModal-motherEmailLink"></a></li>
                    <li class="list-group-item"> 
                        <b>Mother's Slack:	</b><a class="infoModal-motherSlackDMLink" target="_blank"><span class="infoModal-motherSlackUsername"></span><span class="infoModal-motherSlackDMLoadingText"></span></a>
                    </li>
                    <li class="list-group-item"> <b>Date Joined Troop 485:	</b><span class="infoModal-scoutJoinDate"></span></li>
                    <li class="list-group-item"> <b>Active:	</b><span class="infoModal-scoutActive"></span></li>
                    <li class="list-group-item"> <b>Wilderness First Aid Trained:	</b><span class="infoModal-scoutWFATrained"></span></li>
                    <li class="list-group-item"> <b>School Attending:	</b><span class="infoModal-scoutSchool"></span></li>
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Edit in spreadsheet</button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

</body>